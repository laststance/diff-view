# Diff View 差分ハイライト機能 PRD

## 1. 概要

本PRDは、人気のオンラインDiffツール「difff.jp」の差分ハイライト仕様を分析し、Diff Viewアプリケーションへの実装要件を定義します。

## 2. 参考実装の分析結果

### 2.1 調査対象
- ツール名: difff.jp (https://difff.jp/en/)
- バージョン: ver.6.1
- 調査日: 2025年（検証実施）

### 2.2 レイアウト構造

#### 2.2.1 全体構成
- **2カラムテーブルレイアウト**
  - 左カラム: 旧バージョンのテキスト
  - 右カラム: 新バージョンのテキスト
- **行ベースの比較**
  - 各行が1つのテーブル行として表示
  - 左右のセルが対応する行を表現

#### 2.2.2 表示領域
- フルページ幅を活用
- スクロール可能な長いテキストに対応
- レスポンシブ対応（画面サイズに応じて調整）

### 2.3 差分ハイライト仕様

#### 2.3.1 追加コンテンツの表示
- **背景色**: GitHub風グリーン（推定: #22863a または #28a745）
- **適用範囲**: 右カラム（新バージョン）の追加された部分のみ
- **粒度**: 文字レベル・単語レベルの高精度ハイライト

**例:**
```
左: test.beforeAll(async () => {
右: test.beforeEach(async () => {
    ^^^^^^^^ ← "Each"部分が緑色背景でハイライト（GitHub風）
```

#### 2.3.2 削除コンテンツの表示
- **背景色**: 左カラムにピンク色ハイライトを適用（GitHub風、推定: #ffebe9 または #ffd7d5）
- **適用範囲**: 左カラム（旧バージョン）の削除された部分のみ
- **粒度**: 文字レベル・単語レベル

#### 2.3.3 変更コンテンツの表示
- 左カラムに削除部分をハイライト
- 右カラムに追加部分をハイライト
- 同一行内での変更を視覚的に明確化

#### 2.3.4 未変更コンテンツの表示
- **背景色**: 白色/背景色なし
- **表示**: 左右両方のカラムに同一テキストを表示
- **ハイライトなし**: 差分がないことを視覚的に示す

### 2.4 ハイライトの特徴

#### 2.4.1 粒度の高精度性
- **文字レベルの精密性**
  - 1文字の追加・削除も正確に検出
  - 単語の一部の変更も正確にハイライト
- **単語境界の認識**
  - 空白、記号による単語区切りを認識
  - 意味のある単位でハイライト

#### 2.4.2 視認性
- **高コントラスト**: 緑色背景（追加）とピンク背景（削除）により変更箇所が明瞭
- **スキャン性**: 縦方向にスクロールしながら差分を素早く確認可能
- **直感的理解**: 色の有無で変更/未変更を即座に判別

#### 2.4.3 インライン表示
- テキストの流れを維持したまま差分を表示
- 前後のコンテキストを保持
- コードの構造を崩さない

## 3. Diff View実装要件

### 3.1 現在のアプリとの差異

#### 3.1.1 主な課題
現在のDiff Viewアプリは以下の問題を抱えています:

1. **UXの問題**
   - ユーザビリティが低く、実用性に欠ける
   - 差分の視認性が不十分

2. **機能の不足**
   - difff.jpのような高精度な差分ハイライトが未実装
   - 視覚的な差分表現が不明瞭

### 3.2 実装すべき機能仕様

#### 3.2.1 リアルタイム差分表示
- **difff.jpとの違い**: Compareボタン不要
- **動作**: テキスト入力と同時に差分を自動計算・表示
- **パフォーマンス**: デバウンス処理により適切なタイミングで更新

#### 3.2.2 ハイライトカラー仕様

**追加コンテンツ**
```css
background-color: #22863a; /* GitHub風グリーン（明るい緑） */
/* または #28a745（GitHub標準グリーン）、#2ea043（GitHub darkモードグリーン） */
```

**削除コンテンツ**
```css
background-color: #FFB6C1; /* ライトピンク（推奨） */
/* または #ffebe9、#ffd7d5（GitHub風ライトピンク/レッド） */
```

**変更コンテンツ**
- 削除部分: 削除色を適用
- 追加部分: 追加色を適用

#### 3.2.3 レイアウト仕様

**Split View（分割表示）**
- 2カラムテーブルレイアウト
- 左: 旧テキスト（leftContent）
- 右: 新テキスト（rightContent）
- 各行を対応させて表示

**Unified View（統合表示）**
- 単一カラム表示
- 削除行と追加行を連続して表示
- 行全体に背景色を適用

#### 3.2.4 差分アルゴリズム要件

**アルゴリズム選択**
- Myers差分アルゴリズム（推奨）
- または同等の高精度アルゴリズム

**処理単位**
- 行単位での差分検出
- 行内での文字レベル差分検出
- 単語境界を考慮した最適化

**出力形式**
```typescript
interface DiffResult {
  type: 'added' | 'removed' | 'unchanged' | 'modified';
  oldText?: string;
  newText?: string;
  highlightRanges?: Array<{
    start: number;
    end: number;
    type: 'added' | 'removed';
  }>;
}
```

#### 3.2.5 パフォーマンス要件

**処理速度**
- 10,000文字までのテキスト: 100ms以内
- 50,000文字までのテキスト: 500ms以内

**メモリ使用量**
- 効率的な差分計算
- 不要なデータの即座解放

**デバウンス設定**
- 入力停止後300ms待機してから差分計算実行

### 3.3 UI/UX要件

#### 3.3.1 視覚的階層
1. **最優先**: 差分ハイライト
2. **次点**: 行番号、構造
3. **補助**: その他のUI要素

#### 3.3.2 アクセシビリティ
- **カラーコントラスト**: WCAG AA基準以上
- **キーボードナビゲーション**: 差分間の移動をサポート
- **スクリーンリーダー**: 差分情報の適切な読み上げ

#### 3.3.3 レスポンシブデザイン
- 小画面でも差分が判読可能
- モバイルデバイス対応
- 横スクロールの適切な処理

### 3.4 技術スタック推奨

#### 3.4.1 差分計算ライブラリ
- **diff-match-patch** (Google製)
- **fast-diff** (高速軽量)
- **diff** (npm標準パッケージ)

#### 3.4.2 UIコンポーネント
現在使用中の `@git-diff-view/react` を活用しつつ、以下を検討:
- カスタムハイライトロジックの実装
- リアルタイム更新の最適化

## 4. 実装優先度

### 4.1 Phase 1: 基本ハイライト機能（必須）
- Split Viewでの文字レベル差分ハイライト
- 追加/削除の明確な色分け
- リアルタイム差分計算

### 4.2 Phase 2: UI/UX改善（重要）
- ハイライトカラーの調整と視認性向上
- パフォーマンス最適化
- デバウンス処理の実装

### 4.3 Phase 3: 高度な機能（推奨）
- Unified Viewでのハイライト対応
- 差分間のナビゲーション機能
- カスタムカラーテーマ

## 5. 受け入れ基準

### 5.1 機能要件
- ✅ リアルタイムで差分が表示される
- ✅ 文字レベルで正確にハイライトされる
- ✅ 追加/削除が明確に識別できる
- ✅ difff.jpと同等以上の視認性を実現

### 5.2 パフォーマンス要件
- ✅ 10,000文字以内のテキストで遅延を感じない
- ✅ メモリリークが発生しない
- ✅ CPUリソース使用が最適化されている

### 5.3 品質要件
- ✅ ユニットテストカバレッジ80%以上
- ✅ E2Eテストで主要シナリオをカバー
- ✅ アクセシビリティチェック合格

## 6. 参考資料

### 6.1 分析対象
- difff.jp URL: https://difff.jp/en/
- スクリーンショット: `.playwright-mcp/difff-comparison-full.png`
- 詳細スクリーンショット: `.playwright-mcp/difff-comparison-detail.png`

### 6.2 技術文献
- Myers差分アルゴリズム論文
- Google diff-match-patchドキュメント
- Git Diff内部実装

### 6.3 既存実装
- 現在の `@git-diff-view/react` 実装
- DiffViewerコンポーネント仕様

## 7. 補足事項

### 7.1 difff.jpとの主な違い
1. **Compareボタン**: 不要（リアルタイム更新）
2. **オフライン動作**: Electronアプリのため完全オフライン
3. **統合表示**: Unified Viewも提供

### 7.2 実装上の注意点
- 既存のZustand storeとの整合性維持
- @git-diff-view/reactライブラリとの互換性
- パフォーマンスを犠牲にしない範囲での実装

---

**Document Version**: 1.0
**Last Updated**: 2025年
**Author**: Claude Code (via Playwright analysis)
**Status**: Draft
